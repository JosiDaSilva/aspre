<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <link rel="stylesheet" href="/css/inicio.css"> <!-- Archivo CSS separado -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Incluye jQuery -->
</head>
<body>
    <header class="main-header">
        <div class="logo">
            <img src="/images/logo.png" alt="Logo">
        </div>
        <div class="welcome-message">
            <p>Bienvenido, <%= razon %></p>
            <span id="carrito-icon" class="carrito-icon" title="Ver carrito">üõí</span>
            <span id="calculator-icon" class="calculator-icon" title="Calcular utilidad y descuento">üßÆ</span> <!-- Icono de calculadora -->
            <!-- Bot√≥n de cerrar sesi√≥n -->
            <button id="logout-button" class="btn">Cerrar sesi√≥n</button>
        </div>
    </header>

    <main class="main-content">
        <h1>¬°Bienvenido al Cat√°logo online oficial de Autopartes Sol SRL!</h1>
        <p>Aqu√≠ puedes acceder a la informaci√≥n relevante de tu cuenta.</p>

        <!-- Botones para redirigir a otras p√°ginas -->
        <div class="buttons-container" style="display: flex; gap: 20px;">
        <a href="/cuentacorriente" class="btn" style="position: relative; display: flex; flex-direction: column; align-items: center; text-decoration: none;">
        <img src="/images/comprobado.png" alt="Comprobantes" class="icon" style="width: 48px; height: 48px; margin-bottom: 10px;">
        <span>Comprobantes</span>
    </a>
    <a href="/precios" class="btn" style="position: relative; display: flex; flex-direction: column; align-items: center; text-decoration: none;">
        <img src="/images/precio.png" alt="precios" class="icon" style="width: 48px; height: 48px; margin-bottom: 10px;">
        <span>Precios y Art√≠culos</span>
    </a>
    <a href="/ofertas" class="btn" style="position: relative; display: flex; flex-direction: column; align-items: center; text-decoration: none;">
        <img src="/images/oferta.png" alt="oferta" class="icon" style="width: 48px; height: 48px; margin-bottom: 10px;">
        <span>Nuestras Ofertas</span>
    </a>
            <a href="/estado" class="btn" style="position: relative; display: flex; flex-direction: column; align-items: center; text-decoration: none;">
        <img src="/images/rastreo.png" alt="seguimiento" class="icon" style="width: 48px; height: 48px; margin-bottom: 10px;">
        <span>Seguimiento de Pedido</span>
    </a>
     <a href="#" class="btn" style="position: relative; display: flex; flex-direction: column; align-items: center; text-decoration: none;">
        <img src="/images/logo.png" alt="utilidad" class="icon" style="width: 48px; height: 48px; margin-bottom: 10px;">
        <span>Utilidad por Proveedor</span>
    </a>
            
        </div>
    </main>

    <!-- Modal para mostrar el carrito -->
    <div id="carrito-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Carrito de Compras</h2>
             <div class="container">
                <div id="misiones" class="column">
                    <h3>Misiones</h3>
                </div>
                <div id="corrientes" class="column">
                    <h3>Corrientes</h3>
                </div>
            </div>
            <button id="enviar-pedido">Enviar Pedido</button>
        </div>
    </div>

    <!-- Modal para calcular utilidad y descuento -->
    <div id="calculator-modal" class="modal">
        <div class="modal-content">
            <span class="close-calculator">&times;</span>
            <h2>Ingrese los datos</h2>
            <form id="utilidad-form">
                <label for="util">Utilidad:</label>
                <input type="text" id="util" name="util" placeholder="Utilidad" required>
                
                <label for="dtofab">Descuento:</label>
                <input type="text" id="dtofab" name="dtofab" placeholder="Descuento" readonly required>
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Abrir el modal del carrito
            $("#carrito-icon").click(function() {
                $.get("/carrito", function(data) {
                    renderItems(data); 
                });
            });

            
            function renderItems(items) {
               
                const misionesContainer = $("#misiones");
                const corrientesContainer = $("#corrientes");

                
                misionesContainer.html('<h3>Misiones</h3>');
                corrientesContainer.html('<h3>Corrientes</h3>');

                
                items.forEach(item => {
                    
                    const itemDiv = $(`
                        <div class="carrito-details">
                            <p>${item.codbar}</p>
                            <p>${item.descripcion}</p>
                            <input type="number" class="cantidad-input" value="${item.cantidad}" min="1" data-codbar="${item.codbar}">
                            <p>Precio: $${item.precio.toFixed(2)}</p>
                            <p>Total: <span class="item-total">$${(item.precio * item.cantidad).toFixed(2)}</span></p>
                            <p>Articulo para Zona: ${item.zona}</p>
                            <button class="actualizar-btn" data-codbar="${item.codbar}">Actualizar</button>
                            <button class="eliminar-btn" data-codbar="${item.codbar}">‚úñ</button>
                        </div>
                    `);

                    
                    if (item.zona === 1) {
                        misionesContainer.append(itemDiv);
                    } else if (item.zona === 2) {
                        corrientesContainer.append(itemDiv);
                    }
                });

               
                $("#carrito-modal").show();
            }

            // Cerrar el modal del carrito
            $(".close").click(function() {
                $("#carrito-modal").hide();
            });
    
            // Cerrar el modal si se hace clic fuera de √©l
            $(window).click(function(event) {
                if (event.target == document.getElementById('carrito-modal')) {
                    $("#carrito-modal").hide();
                }
            });
    
            // Manejar el env√≠o del pedido
            $("#enviar-pedido").click(function() {
                const sucursal = prompt("¬øA qu√© sucursal deseas enviar el pedido? (escriba 1 para Misiones o 2 para Corrientes)");

                if (sucursal === null) {
                    return; // Si el usuario cancela, no se env√≠a el pedido
                }

                let zona;
                if (sucursal.toLowerCase() === '1') {
                    zona = 1; // Zona 1 es Misiones
                } else if (sucursal.toLowerCase() === '2') {
                    zona = 2; // Zona 2 es Corrientes
                } else {
                    alert("Sucursal no v√°lida. Por favor, elige 'Misiones' o 'Corrientes'.");
                    return;
                }

                const transporte = prompt("Por favor, escribe el transporte:");
                const obs = prompt("Por favor, escribe una observaci√≥n (opcional):");

                $.post("/enviar-pedido", { transporte: transporte, obs: obs, zona: zona })
                    .done(function(response) {
                        alert(response.message);
                        $("#carrito-modal").hide(); // Cerrar el modal del carrito
                    })
                    .fail(function() {
                        alert("Hubo un problema al enviar el pedido.");
                    });
            });

            // Actualizar la cantidad
            $(document).on('click', '.actualizar-btn', function() {
                const codbar = $(this).data('codbar');
                const nuevaCantidad = $(this).siblings('.cantidad-input').val();
    
                $.post("/actualizar-cantidad", { codbar: codbar, cantidad: nuevaCantidad })
                    .done(function(response) {
                        alert("Cantidad actualizada con √©xito.");
                        actualizarTotal();
                    })
                    .fail(function() {
                        alert("Hubo un problema al actualizar la cantidad.");
                    });
            });
    
            // Eliminar art√≠culo del carrito
            $(document).on('click', '.eliminar-btn', function() {
                const codbar = $(this).data('codbar');
    
                $.post("/eliminar-articulo", { codbar: codbar })
                    .done(function(response) {
                        alert("Art√≠culo eliminado con √©xito.");
                        $("#carrito-icon").click();
                    })
                    .fail(function() {
                        alert("Hubo un problema al eliminar el art√≠culo.");
                    });
            });
    
            // Funci√≥n para recalcular el total del carrito
            function actualizarTotal() {
                let total = 0;
    
                $(".carrito-item").each(function() {
                    const cantidad = $(this).find('.cantidad-input').val();
                    const precio = parseFloat($(this).find('p').eq(1).text().replace("Precio: $", ""));
                    const itemTotal = precio * cantidad; // Calcula el total por art√≠culo
                    $(this).find('.item-total').text(`$${itemTotal.toFixed(2)}`); // Actualiza el total del art√≠culo
                    total += itemTotal; // Sumar al total general
                });
    
                $(".total").text(`Total: $${total.toFixed(2)}`); // Actualiza el total del carrito
            }

            // Abrir el modal de la calculadora
            // Abrir el modal de la calculadora
            $("#calculator-icon").click(function() {
                // Obtener los valores de util y dtofab desde el servidor
                $.get("/obtener-valores", function(data) {
                    $("#util").val(data.util); // Asigna el valor de utilidad al input correcto
                    $("#dtofab").val(data.dtofab); // Asigna el valor de descuento al input correcto
                    $("#calculator-modal").show(); // Mostrar el modal
                }).fail(function() {
                    alert("Error al obtener los valores.");
                });
            });


            // Cerrar el modal de la calculadora
            $(".close-calculator").click(function() {
                $("#calculator-modal").hide();
            });

            // Cerrar el modal si se hace clic fuera de √©l
            $(window).click(function(event) {
                if (event.target == document.getElementById('calculator-modal')) {
                    $("#calculator-modal").hide();
                }
            });

            // Manejar el env√≠o del formulario de la calculadora
            $("#utilidad-form").submit(function(event) {
                event.preventDefault(); // Evitar el env√≠o normal del formulario
                const utilidad = $("#util").val(); // Cambiar a 'util'
                const descuento = $("#dtofab").val(); // Cambiar a 'dtofab'

                $.post("/guardar-valores", { util: utilidad, dtofab: descuento }) // Cambiar nombres aqu√≠
                    .done(function(response) {
                        alert("Valores guardados con √©xito.");
                        $("#calculator-modal").hide(); // Cerrar el modal de la calculadora
                    })
                    .fail(function() {
                        alert("Hubo un problema al guardar los valores.");
                    });
            });

            // Cerrar sesi√≥n
            $("#logout-button").click(function() {
                $.post("/logout", function(response) {
                    alert(response.message);
                    window.location.href = "/"; // Redirigir a la p√°gina de inicio
                });
            });
        });
    </script>
</body>
</html>
